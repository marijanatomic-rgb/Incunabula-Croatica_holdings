<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inkunabule — karta ustanova (HR)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  html, body, #map { height: 100%; margin: 0; }
  .panel {
    position: absolute; top: 10px; left: 10px; z-index: 1000;
    background: rgba(255,255,255,0.96); padding: 10px; border-radius: 10px; border: 1px solid #ddd;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 14px; max-width: 460px;
  }
  .panel h3 { margin: 0 0 8px 0; font-size: 16px; }
  .panel label { display:block; margin-top: 6px; font-weight: 600; }
  .panel select { width: 100%; padding: 6px; border:1px solid #ccc; border-radius:8px; }
  .hint { font-size: 12px; color:#555; margin-top:2px; }
  .row { display:flex; gap:8px; align-items:center; }
  .row > div { flex:1; }
  .btns { display:flex; gap:8px; margin-top:8px; flex-wrap: wrap; }
  button { padding:6px 10px; border:1px solid #ccc; border-radius: 8px; background:#f6f6f6; cursor:pointer; }
  button:hover { background:#eee; }
  .inst-list details summary { cursor: pointer; }
  .inst-list table { width:100%; border-collapse:collapse; font-size:13px; }
  .inst-list th, .inst-list td { padding:4px; border-bottom:1px solid #eee; text-align:left; }
  .badge { display:inline-block; padding:2px 6px; border-radius:8px; background:#eef; border:1px solid #ccd; font-size:12px; }
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h3>Filtri (ustanove u Hrvatskoj)</h3>

  <label>Mjesto (ustanove) — višestruki odabir</label>
  <select id="placeSelect" multiple size="6"></select>
  <div class="hint">Savjet: držite Ctrl/Cmd za višestruki odabir.</div>

  <label>Ustanova — višestruki odabir</label>
  <select id="instSelect" multiple size="6"></select>

  <label>Tiskar — višestruki odabir</label>
  <select id="printerSelect" multiple size="6"></select>

  <label>Mjesto tiskanja — višestruki odabir</label>
  <select id="printPlaceSelect" multiple size="6"></select>

  <label>Autor — višestruki odabir</label>
  <select id="authorSelect" multiple size="6"></select>

  <div class="btns">
    <button id="applyBtn">Primijeni</button>
    <button id="resetBtn">Poništi</button>
    <button id="dlTitlesBtn">Preuzmi CSV — Naslovi (primjerci)</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
  const RAW = [{"place": "Bol", "lat": 43.2605186, "lon": 16.6520192, "total": 1, "institutions": [{"institution": "Dominikanski samostan Sv. Marije Milosne", "count": 1, "exemplars": [{"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}]}]}, {"place": "Cavtat", "lat": 42.5814314, "lon": 18.2177461, "total": 33, "institutions": [{"institution": "Zbirka Baltazara Bogišića", "count": 33, "exemplars": [{"author": "VARRO, MARCUS TERENTIUS", "title": "De lingua Latina lib. III.", "year": 1483, "printer": "Dobrićević, Dobrić Delsera, Miniatus", "print_places": ["Brescia"]}, {"author": "", "title": "Elegiae", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "TIBULLUS, ALBIUS", "title": "Elegiae sive carmina", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "", "title": "Statuta Cremonae", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "PUCIÆ, KARLO", "title": "Elegiarum libellus De laudibus Gnesae puellae", "year": 1495, "printer": "Damianus de Gorgonzola", "print_places": ["Venecija"]}, {"author": "PROPERTIUS, SEXTUS AURELIUS", "title": "Elegiae", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "PROPERTIUS, SEXTUS AURELIUS", "title": "Elegiae", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "PLUTARCHUS", "title": "Parallela minora", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "PLUTARCHUS", "title": "De claris mulieribus. De virtutibus mulierum.", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "NONIUS MARCELLUS", "title": "De proprietate Latini sermonis.", "year": 1483, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "NIKOLA MODRUŠKI", "title": "Oratio in funere Petri cardinalis s. Sixti habita.", "year": 1481, "printer": "Plannck, Stephan", "print_places": ["Rim"]}, {"author": "NIKOLA MODRUŠKI", "title": "Oratio in funere Petri cardinalis s. Sixti habita.", "year": 1474, "printer": "Gensberg, Johannes", "print_places": ["Rim"]}, {"author": "MARCHESINUS, JOHANNES", "title": "Mammotrectus super Bibliam.", "year": 1482, "printer": "Paltašić, Andrija Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "MACROBIUS, AURELIUS THEODOSIUS", "title": "In somnium Scipionis expositio. Saturnalia.", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "LUDOVICUS A TURRI DE VERONA", "title": "De immaculata conceptione B.V. Mariae", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "LACTANTIUS, LUCIUS CAECILIUS FIRMIANUS", "title": "Opera", "year": 1478, "printer": "Paltašić, Andrija Dobrićević, Dobrić", "print_places": ["Venecija"]}, {"author": "JACOBUS PHILIPPUS DE BERGAMO", "title": "Supplementum chronicarum", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1477, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "FESTUS, SEXTUS POMPEIUS", "title": "De verborum significatione", "year": 1483, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "Oratio funebris pro Junio Georgio habita", "year": 1499, "printer": "Nepoznat", "print_places": ["Firenza"]}, {"author": "DIODORUS, SICULUS Tacitus, Gaius Cornelius", "title": "Bibliothecae historicae libri VI.", "year": 1476, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "CICERO, MARCUS TULLIUS", "title": "Epistolae ad familiares", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "CATULLUS, GAIUS VALERIUS", "title": "Carmina", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "BURLAEUS, GUALTHERUS", "title": "Expositio in artem veterem Porphyrii et Aristotelis", "year": 1492, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BLONDUS, FLAVIUS", "title": "Roma instaurata.", "year": 1481, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}, {"author": "BALDUS DE UBALDIS", "title": "Consiliorum partes V.", "year": 1490, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "AURELIUS, VICTOR SEXTUS", "title": "De viris illustribus", "year": 1477, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "AURELIUS, VICTOR SEXTUS", "title": "De viris illustribus", "year": 1477, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "ANTONINUS FLORENTINUS", "title": "Summa theologica. Pars III.", "year": 1485, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "ALBERTUS MAGNUS, SANCTUS", "title": "Compendium theologicae veritatis", "year": 1483, "printer": "Grgur Senjanin Jacobum Britannicum", "print_places": ["Venecija"]}, {"author": "ALBERTUS DE SAXONIA", "title": "De proportionibus.", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "AEGIDII, GUILLERMUS", "title": "Super coelestium motuum indigatione", "year": 1494, "printer": "Darleri, Carlo", "print_places": ["Cremona"]}]}]}, {"place": "Cres", "lat": 44.960346, "lon": 14.4079371, "total": 1, "institutions": [{"institution": "Franjevački samostan sv. Franje", "count": 1, "exemplars": [{"author": "", "title": "Senjski glagoljski misal", "year": 1494, "printer": "Bedrièić, Silvestar Turèić, Gašpar Baromić, Blaž", "print_places": ["Senj"]}]}]}, {"place": "Dubrovnik", "lat": 42.6507, "lon": 18.0944, "total": 18, "institutions": [{"institution": "Državni arhiv Dubrovnik", "count": 1, "exemplars": [{"author": "BALDUS DE UBALDIS", "title": "Consiliorum partes V.", "year": 1490, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}]}, {"institution": "Franjevački samostan Male braće", "count": 10, "exemplars": [{"author": "SUETONIUS TRANQUILLUS, GAIUS", "title": "Vitae XII caesarum", "year": 1488, "printer": "Benedictis, Franciscus (Plato) de", "print_places": ["Bologna"]}, {"author": "ODONIS, GERALDUS", "title": "Expositio in Aristotelis Ethica", "year": 1482, "printer": "Dobrićević, Dobrić Manerva, Bonifacius de", "print_places": ["Brescia"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1475, "printer": "Pietro, Gabriele di", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1480, "printer": "Typ. Hieronymi", "print_places": ["Parma"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "Oratio funebris pro Junio Georgio habita", "year": 1499, "printer": "Nepoznat", "print_places": ["Firenza"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "De natura angelica.", "year": 1499, "printer": "Libris, Bartholomeo de", "print_places": ["Firenza"]}, {"author": "CIPIKO, KORIOLAN", "title": "Petri Mocenici imperatoris gesta", "year": 1477, "printer": "Ratdolt, Erhard Löslein, Peter", "print_places": ["Venecija"]}, {"author": "Aristotelis", "title": "Auctoritates", "year": 1495, "printer": "Paganini, Paganino de’, st.", "print_places": ["Venecija"]}, {"author": "ALBERTUS MAGNUS, SANCTUS", "title": "Compendium theologicae veritatis", "year": 1483, "printer": "Grgur Senjanin Jacobum Britannicum", "print_places": ["Venecija"]}]}, {"institution": "Znanstvena knjižnica", "count": 7, "exemplars": [{"author": "JACOBUS PHILIPPUS DE BERGAMO", "title": "Supplementum chronicarum", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "IUVENALIS, DECIMUS IUNIUS", "title": "Satyrae", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "De natura angelica.", "year": 1499, "printer": "Libris, Bartholomeo de", "print_places": ["Firenza"]}, {"author": "CICERO, MARCUS TULLIUS", "title": "Epistole ad familiares", "year": 1480, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "CICERO, MARCUS TULLIUS", "title": "De oratore", "year": 1478, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BLONDUS, FLAVIUS", "title": "Roma instaurata.", "year": 1481, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}]}]}, {"place": "Hvar", "lat": 43.1729, "lon": 16.4424, "total": 5, "institutions": [{"institution": "Franjevački samostan Gospe od milosti", "count": 3, "exemplars": [{"author": "LUDOVICUS A TURRI DE VERONA", "title": "De immaculata conceptione B.V. Mariae", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1476, "printer": "Miscomini, Antonio di Bartolommeo", "print_places": ["Venecija"]}, {"author": "CICERO, MARCUS TULLIUS", "title": "Epistole ad familiares", "year": 1480, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}]}, {"institution": "Knjižnica Hvarske biskupije", "count": 2, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}]}, {"place": "Kampor", "lat": 44.7768332, "lon": 14.7279432, "total": 2, "institutions": [{"institution": "Franjevački samostan sv. Bernardina Sijenskog", "count": 2, "exemplars": [{"author": "MARCHESINUS, JOHANNES", "title": "Mammotrectus super Bibliam.", "year": 1482, "printer": "Paltašić, Andrija Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1476, "printer": "Miscomini, Antonio di Bartolommeo", "print_places": ["Venecija"]}]}]}, {"place": "Koprivnica", "lat": 46.1623335, "lon": 16.8307909, "total": 1, "institutions": [{"institution": "Franjevački samostan sv. Antuna Padovanskog", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}]}, {"place": "Košljun", "lat": 45.037, "lon": 14.5955, "total": 6, "institutions": [{"institution": "Franjevački samostan Navještenja Marijina", "count": 6, "exemplars": [{"author": "ŠIMUN HVARANIN", "title": "De baptismo Sancti Spiritus et eius virtute", "year": 1477, "printer": "Gallo, Guglielmo", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1483, "printer": "Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1489, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}, {"author": "Aristotelis", "title": "Auctoritates", "year": 1495, "printer": "Paganini, Paganino de’, st.", "print_places": ["Venecija"]}, {"author": "ANTONINUS FLORENTINUS", "title": "Summa theologica. Pars III.", "year": 1485, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}]}]}, {"place": "Kraj", "lat": 43.96, "lon": 15.378, "total": 1, "institutions": [{"institution": "Franjevački samostan sv. Duje", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}]}]}, {"place": "Našice", "lat": 45.4907759, "lon": 18.0938075, "total": 1, "institutions": [{"institution": "Franjevački samostan sv. Antuna Padovanskog", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}]}, {"place": "Pula", "lat": 44.8666, "lon": 13.8496, "total": 2, "institutions": [{"institution": "Sveučilišna knjižnica u Puli", "count": 2, "exemplars": [{"author": "VERGERIUS, PETRUS PAULUS", "title": "De ingenuis moribus ac liberalibus studiis", "year": 1475, "printer": "Siliprandi, Domenico", "print_places": ["Padova"]}, {"author": "PHALARIS", "title": "Epistolae", "year": 1498, "printer": "Pelusius, Bartholomaeus Bracius, Gabriel Bissolus, Johannes Mangius, Benedictus", "print_places": ["Venecija"]}]}]}, {"place": "Rijeka", "lat": 45.3271, "lon": 14.4422, "total": 1, "institutions": [{"institution": "Franjevački samostan Majke Božje Trsatske", "count": 1, "exemplars": [{"author": "", "title": "EVANGELISTARIUM ILLYRICUM", "year": 1495, "printer": "Damianus de Gorgonzola", "print_places": ["Venecija"]}]}]}, {"place": "Split", "lat": 43.5081, "lon": 16.4402, "total": 9, "institutions": [{"institution": "Arheološki muzej", "count": 3, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1490, "printer": "Bonaccorsi, Francesco", "print_places": ["Firenza"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1497, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1489, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}]}, {"institution": "Bogoslovno sjemenište", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1476, "printer": "Miscomini, Antonio di Bartolommeo", "print_places": ["Venecija"]}]}, {"institution": "Dominikanski samostan sv. Katarine", "count": 2, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1480, "printer": "Typ. Hieronymi", "print_places": ["Parma"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}, {"institution": "Franjevački samostan svetog Ante", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1480, "printer": "Typ. Hieronymi", "print_places": ["Parma"]}]}, {"institution": "Katolički bogoslovni fakultet", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1497, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}]}, {"institution": "Prva gimnazija Split", "count": 1, "exemplars": [{"author": "ARISTOTELES", "title": "Politica", "year": 1492, "printer": "Silber, Eucharius", "print_places": ["Rim"]}]}]}, {"place": "Trogir", "lat": 43.5167, "lon": 16.25, "total": 1, "institutions": [{"institution": "Muzej grada Trogira", "count": 1, "exemplars": [{"author": "CIPIKO, KORIOLAN", "title": "Petri Mocenici imperatoris gesta", "year": 1477, "printer": "Ratdolt, Erhard Löslein, Peter", "print_places": ["Venecija"]}]}]}, {"place": "Varaždin", "lat": 46.3057, "lon": 16.3366, "total": 1, "institutions": [{"institution": "Franjevački samostan sv. Ivana Krstitelja", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1483, "printer": "Scotus, Octavianus", "print_places": ["Venecija"]}]}]}, {"place": "Visovac", "lat": 43.8611444, "lon": 15.9732853, "total": 1, "institutions": [{"institution": "Franjevački samostan Gospe od anđela", "count": 1, "exemplars": [{"author": "AESOPUS", "title": "Aesopus moralisatus", "year": 1487, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}]}]}, {"place": "Zadar", "lat": 44.1194, "lon": 15.2314, "total": 12, "institutions": [{"institution": "Državni arhiv u Zadru", "count": 1, "exemplars": [{"author": "CIPIKO, KORIOLAN", "title": "Petri Mocenici imperatoris gesta", "year": 1477, "printer": "Ratdolt, Erhard Löslein, Peter", "print_places": ["Venecija"]}]}, {"institution": "Franjevački samostan sv. Frane", "count": 7, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1479, "printer": "Girardengus, Nicolaus, de Novis", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistole", "year": 1490, "printer": "Benalius, Bernardinus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1480, "printer": "Typ. Hieronymi", "print_places": ["Parma"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super secunda parte Digesti veteris cum additionibus Alexandri Tartagni.", "year": 1492, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super prima parte Codicis cum additionibus Alexandri Tartagni.", "year": 1491, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super secunda parte Codicis cum additionibus Alexandri Tartagni.", "year": 1490, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super prima parte Digesti veteris cum additionibus Alexandri Tartagni.", "year": 1490, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}]}, {"institution": "Nadbiskupski ordinarijat", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1487, "printer": "Hannibal Foxius", "print_places": ["Venecija"]}]}, {"institution": "Znanstvena knjižnica Sveučilišta u Zadru", "count": 3, "exemplars": [{"author": "LACTANTIUS, LUCIUS CAECILIUS FIRMIANUS", "title": "Opera", "year": 1478, "printer": "Paltašić, Andrija Dobrićević, Dobrić", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "BLONDUS, FLAVIUS", "title": "Roma instaurata.", "year": 1481, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}]}]}, {"place": "Zagreb", "lat": 45.815, "lon": 15.9819, "total": 75, "institutions": [{"institution": "Franjevački samostan sv. Franje Asiškog", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1470, "printer": "Sweynheym, Konrad Pannartz, Arnold", "print_places": ["Rim"]}]}, {"institution": "Knjižnica 'Juraj Habdelić'", "count": 4, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1476, "printer": "Miscomini, Antonio di Bartolommeo", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}, {"author": "", "title": "EVANGELISTARIUM ILLYRICUM", "year": 1495, "printer": "Damianus de Gorgonzola", "print_places": ["Venecija"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "De natura angelica.", "year": 1499, "printer": "Libris, Bartholomeo de", "print_places": ["Firenza"]}]}, {"institution": "Knjižnica Hrvatske akademije znanosti i umjetnosti", "count": 6, "exemplars": [{"author": "TERENTIUS AFER, PUBLIUS", "title": "Comoediae", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "ŠIŽGORIÆ, JURAJ", "title": "Elegiarum et carminum libri tres.", "year": 1477, "printer": "Adamus, Rotwilensis", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1497, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "De natura angelica.", "year": 1499, "printer": "Libris, Bartholomeo de", "print_places": ["Firenza"]}, {"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}, {"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}]}, {"institution": "Knjižnice Grada Zagreba", "count": 1, "exemplars": [{"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}]}, {"institution": "Metropolitanska knjižnica", "count": 10, "exemplars": [{"author": "VALTURIUS, ROBERTUS", "title": "De re militari", "year": 1483, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}, {"author": "MACROBIUS, AURELIUS THEODOSIUS", "title": "In somnium Scipionis expositio. Saturnalia.", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "MACROBIUS, AURELIUS THEODOSIUS", "title": "In somnium Scipionis expositio. Saturnalia.", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1483, "printer": "Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1485, "printer": "Pasqualibus, Peregrinus de Bertochus, Dominicus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1485, "printer": "Pasqualibus, Peregrinus de Bertochus, Dominicus", "print_places": ["Venecija"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1477, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super secunda parte Digesti veteris cum additionibus Alexandri Tartagni.", "year": 1492, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BARTOLUS DE SAXOFERRATO", "title": "Super prima parte Codicis cum additionibus Alexandri Tartagni.", "year": 1491, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}]}, {"institution": "Muzej suvremene umjetnosti", "count": 1, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}, {"institution": "Nacionalna i sveučilišna knjižnica u Zagrebu", "count": 49, "exemplars": [{"author": "VERGILIUS MARO, PUBLIUS", "title": "Opera", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "VERGERIUS, PETRUS PAULUS", "title": "De ingenuis moribus ac liberalibus studiis", "year": 1497, "printer": "Tacuinus, Giovanni", "print_places": ["Venecija"]}, {"author": "VARRO, MARCUS TERENTIUS", "title": "De lingua Latina lib. III.", "year": 1483, "printer": "Dobrićević, Dobrić Delsera, Miniatus", "print_places": ["Brescia"]}, {"author": "VALTURIUS, ROBERTUS", "title": "De re militari", "year": 1483, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}, {"author": "TORTELLIUS, JOHANNES", "title": "De orthographia dictionum e Graecis tractarum.", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "TIBULLUS, ALBIUS", "title": "Elegiae", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "ŠIMUN HVARANIN", "title": "De baptismo Sancti Spiritus et eius virtute", "year": 1477, "printer": "Gallo, Guglielmo", "print_places": ["Venecija"]}, {"author": "PUCIÆ, KARLO", "title": "Elegiarum libellus De laudibus Gnesae puellae", "year": 1495, "printer": "Damianus de Gorgonzola", "print_places": ["Venecija"]}, {"author": "PROPERTIUS, SEXTUS AURELIUS", "title": "Elegiae", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "PROBUS, MARCUS VALERIUS", "title": "De interpretandis Romanorum litteris.", "year": 1486, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "", "title": "OFFICIUM", "year": 1501, "printer": "Dobrićević, Dobrić", "print_places": ["Lyon"]}, {"author": "NIMIRA, MARTINUS DE", "title": "Sermo de passione Domini.", "year": 1494, "printer": "Silber, Eucharius", "print_places": ["Rim"]}, {"author": "NIKOLA MODRUŠKI", "title": "Oratio in funere Reverendissimi domini D. Petri Cardinalis sancti Sixti habita a revere[n]do patre d[omi]no Nicolao ep[isco]po Modrusien[si]", "year": 1484, "printer": "Guldinbeck, Bartholomaeus", "print_places": ["Rim"]}, {"author": "NIGER, FRANJO", "title": "Modus epistolandi.", "year": 1495, "printer": "Bevilacqua, Simone", "print_places": ["Venecija"]}, {"author": "NIGER, FRANJO", "title": "Modus epistolandi.", "year": 1492, "printer": "Capcasa, Matteo", "print_places": ["Venecija"]}, {"author": "LACTANTIUS, LUCIUS CAECILIUS FIRMIANUS", "title": "Opera", "year": 1478, "printer": "Paltašić, Andrija Dobrićević, Dobrić", "print_places": ["Venecija"]}, {"author": "JACOBUS PHILIPPUS DE BERGAMO", "title": "Supplementum chronicarum", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "JACOBUS DE VORAGINE", "title": "Legenda aurea sanctorum, sive Lombardica historia", "year": 1482, "printer": "Paltašić, Andrija Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1483, "printer": "Scotus, Octavianus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vitae sanctorum patrum, sive Vitas patrum", "year": 1479, "printer": "Lichtenstein, Hermann", "print_places": ["Vicenza"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1489, "printer": "Kessler, Nicolaus", "print_places": ["Basel"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1476, "printer": "Miscomini, Antonio di Bartolommeo", "print_places": ["Venecija"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1485, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "GELLIUS, AULUS", "title": "Noctes Atticae", "year": 1477, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "FIDELIS, CASSANDRA", "title": "Oratio pro Bertucio Lamberto etc.", "year": 1489, "printer": "Wagner, Petrus", "print_places": ["Nürnberg"]}, {"author": "FICINUS, MARSILIUS", "title": "De triplici vita", "year": 1498, "printer": "Pelusius, Bartholomaeus Bracius, Gabriel Bissolus, Johannes Mangius, Benedictus", "print_places": ["Venecija"]}, {"author": "DRAGIŠIÆ, JURAJ", "title": "De natura angelica.", "year": 1499, "printer": "Libris, Bartholomeo de", "print_places": ["Firenza"]}, {"author": "DIONYSIUS CARTHUSIANUS", "title": "Dialogus Mariae et peccatoris etc.", "year": 1480, "printer": "Braem, Konrad", "print_places": ["Löwen"]}, {"author": "DIODORUS, SICULUS Tacitus, Gaius Cornelius", "title": "Bibliothecae historicae libri VI.", "year": 1476, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "CIPIKO, KORIOLAN", "title": "Petri Mocenici imperatoris gesta", "year": 1477, "printer": "Ratdolt, Erhard Löslein, Peter", "print_places": ["Venecija"]}, {"author": "CICERO, MARCUS TULLIUS", "title": "Epistolae ad familiares (comm. Hubertinus Clericus Crescentinas)", "year": 1488, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BURLAEUS, GUALTHERUS", "title": "Expositio in artem veterem Porphyrii et Aristotelis", "year": 1492, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BUNIÆ, JAKOV", "title": "De raptu Cerberi libri tres.", "year": 1490, "printer": "Plannck, Stephan", "print_places": ["Rim"]}, {"author": "BLONDUS, FLAVIUS", "title": "Roma instaurata.", "year": 1481, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}, {"author": "BLONDUS, FLAVIUS", "title": "Roma instaurata.", "year": 1481, "printer": "Dobrićević, Dobrić", "print_places": ["Verona"]}, {"author": "", "title": "BIBLIA", "year": 1484, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "BALDUS DE UBALDIS", "title": "Consiliorum partes V.", "year": 1490, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "ANTONINUS FLORENTINUS", "title": "Summa theologica. Pars III.", "year": 1485, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "ALIGHIERI, DANTE", "title": "La Commedia", "year": 1487, "printer": "Dobrićević, Dobrić", "print_places": ["Brescia"]}, {"author": "ALBUMASAR", "title": "Introductorium in astronomiam", "year": 1489, "printer": "Ratdolt, Erhard", "print_places": ["Augsburg"]}, {"author": "ALBERTUS MAGNUS, SANCTUS", "title": "Compendium theologicae veritatis", "year": 1483, "printer": "Grgur Senjanin Jacobum Britannicum", "print_places": ["Venecija"]}, {"author": "ALBERTUS MAGNUS, SANCTUS", "title": "Compendium theologicae veritatis", "year": 1483, "printer": "Grgur Senjanin Jacobum Britannicum", "print_places": ["Venecija"]}, {"author": "ALBERTUS DE SAXONIA", "title": "De proportionibus.", "year": 1487, "printer": "Paltašić, Andrija", "print_places": ["Venecija"]}, {"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}, {"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}, {"author": "", "title": "Breviarium romanum", "year": 1493, "printer": "Torresanus, Andreas, de Asula Baromić, Blaž", "print_places": ["Venecija"]}, {"author": "", "title": "Breviarium romanum", "year": 1493, "printer": "Torresanus, Andreas, de Asula Baromić, Blaž", "print_places": ["Venecija"]}]}, {"institution": "Samostan sv. Franje ksaverskoga", "count": 2, "exemplars": [{"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}, {"author": "Carcano, Michele", "title": "Spovid općena", "year": 1496, "printer": "Baromić, Blaž", "print_places": ["Senj"]}]}, {"institution": "Staroslavenski institut", "count": 1, "exemplars": [{"author": "", "title": "Misal po zakonu rimskoga dvora", "year": 1483, "printer": "nan", "print_places": []}]}]}, {"place": "Šibenik", "lat": 43.735, "lon": 15.895, "total": 7, "institutions": [{"institution": "Franjevački samostan sv. Frane", "count": 5, "exemplars": [{"author": "ODONIS, GERALDUS", "title": "Expositio in Aristotelis Ethica", "year": 1482, "printer": "Dobrićević, Dobrić Manerva, Bonifacius de", "print_places": ["Brescia"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Vita et transitus", "year": 1480, "printer": "Manzolus, Michael", "print_places": ["Treviso"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1497, "printer": "Rubeis, Laurentius de, de Valentia", "print_places": ["Ferrara"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Pincius, Doninus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Commentaria in Bibliam", "year": 1497, "printer": "Gregoriis, Johannes de", "print_places": ["Venecija"]}]}, {"institution": "Franjevački samostan sv. Lovre", "count": 2, "exemplars": [{"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1496, "printer": "Vercellensis, Johannes Rubeus", "print_places": ["Venecija"]}, {"author": "HIERONYMUS, SANCTUS", "title": "Epistolae", "year": 1470, "printer": "Sweynheym, Konrad Pannartz, Arnold", "print_places": ["Rim"]}]}]}];
  const ALL_STORAGE = ["Bol", "Cavtat", "Cres", "Dubrovnik", "Hvar", "Kampor", "Koprivnica", "Košljun", "Kraj", "Našice", "Pula", "Rijeka", "Split", "Trogir", "Varaždin", "Visovac", "Zadar", "Zagreb", "Šibenik"];
  const ALL_INSTIT  = ["Arheološki muzej", "Bogoslovno sjemenište", "Dominikanski samostan Sv. Marije Milosne", "Dominikanski samostan sv. Katarine", "Državni arhiv Dubrovnik", "Državni arhiv u Zadru", "Franjevački samostan Gospe od anđela", "Franjevački samostan Gospe od milosti", "Franjevački samostan Majke Božje Trsatske", "Franjevački samostan Male braće", "Franjevački samostan Navještenja Marijina", "Franjevački samostan sv. Antuna Padovanskog", "Franjevački samostan sv. Bernardina Sijenskog", "Franjevački samostan sv. Duje", "Franjevački samostan sv. Frane", "Franjevački samostan sv. Franje", "Franjevački samostan sv. Franje Asiškog", "Franjevački samostan sv. Ivana Krstitelja", "Franjevački samostan sv. Lovre", "Franjevački samostan svetog Ante", "Katolički bogoslovni fakultet", "Knjižnica 'Juraj Habdelić'", "Knjižnica Hrvatske akademije znanosti i umjetnosti", "Knjižnica Hvarske biskupije", "Knjižnice Grada Zagreba", "Metropolitanska knjižnica", "Muzej grada Trogira", "Muzej suvremene umjetnosti", "Nacionalna i sveučilišna knjižnica u Zagrebu", "Nadbiskupski ordinarijat", "Prva gimnazija Split", "Samostan sv. Franje ksaverskoga", "Staroslavenski institut", "Sveučilišna knjižnica u Puli", "Zbirka Baltazara Bogišića", "Znanstvena knjižnica", "Znanstvena knjižnica Sveučilišta u Zadru"];
  const ALL_PRINTS  = ["Adamus, Rotwilensis", "Baromić, Blaž", "Bedrièić, Silvestar Turèić, Gašpar Baromić, Blaž", "Benalius, Bernardinus", "Benedictis, Franciscus (Plato) de", "Bevilacqua, Simone", "Bonaccorsi, Francesco", "Braem, Konrad", "Capcasa, Matteo", "Damianus de Gorgonzola", "Darleri, Carlo", "Dobrićević, Dobrić", "Dobrićević, Dobrić Delsera, Miniatus", "Dobrićević, Dobrić Manerva, Bonifacius de", "Gallo, Guglielmo", "Gensberg, Johannes", "Girardengus, Nicolaus, de Novis", "Gregoriis, Johannes de", "Grgur Senjanin Jacobum Britannicum", "Guldinbeck, Bartholomaeus", "Hannibal Foxius", "Kessler, Nicolaus", "Libris, Bartholomeo de", "Lichtenstein, Hermann", "Manzolus, Michael", "Miscomini, Antonio di Bartolommeo", "Nepoznat", "Paganini, Paganino de’, st.", "Paltašić, Andrija", "Paltašić, Andrija Dobrićević, Dobrić", "Paltašić, Andrija Scotus, Octavianus", "Pasqualibus, Peregrinus de Bertochus, Dominicus", "Pelusius, Bartholomaeus Bracius, Gabriel Bissolus, Johannes Mangius, Benedictus", "Pietro, Gabriele di", "Pincius, Doninus", "Plannck, Stephan", "Ratdolt, Erhard", "Ratdolt, Erhard Löslein, Peter", "Rubeis, Laurentius de, de Valentia", "Scotus, Octavianus", "Silber, Eucharius", "Siliprandi, Domenico", "Sweynheym, Konrad Pannartz, Arnold", "Tacuinus, Giovanni", "Torresanus, Andreas, de Asula Baromić, Blaž", "Typ. Hieronymi", "Vercellensis, Johannes Rubeus", "Wagner, Petrus", "nan"];
  const ALL_PPLACES = ["Augsburg", "Basel", "Bologna", "Brescia", "Cremona", "Ferrara", "Firenza", "Lyon", "Löwen", "Nürnberg", "Padova", "Parma", "Rim", "Senj", "Treviso", "Venecija", "Verona", "Vicenza"];
  const ALL_AUTHORS = ["AEGIDII, GUILLERMUS", "AESOPUS", "ALBERTUS DE SAXONIA", "ALBERTUS MAGNUS, SANCTUS", "ALBUMASAR", "ALIGHIERI, DANTE", "ANTONINUS FLORENTINUS", "ARISTOTELES", "AURELIUS, VICTOR SEXTUS", "Aristotelis", "BALDUS DE UBALDIS", "BARTOLUS DE SAXOFERRATO", "BLONDUS, FLAVIUS", "BUNIÆ, JAKOV", "BURLAEUS, GUALTHERUS", "CATULLUS, GAIUS VALERIUS", "CICERO, MARCUS TULLIUS", "CIPIKO, KORIOLAN", "Carcano, Michele", "DIODORUS, SICULUS Tacitus, Gaius Cornelius", "DIONYSIUS CARTHUSIANUS", "DRAGIŠIÆ, JURAJ", "FESTUS, SEXTUS POMPEIUS", "FICINUS, MARSILIUS", "FIDELIS, CASSANDRA", "GELLIUS, AULUS", "HIERONYMUS, SANCTUS", "IUVENALIS, DECIMUS IUNIUS", "JACOBUS DE VORAGINE", "JACOBUS PHILIPPUS DE BERGAMO", "LACTANTIUS, LUCIUS CAECILIUS FIRMIANUS", "LUDOVICUS A TURRI DE VERONA", "MACROBIUS, AURELIUS THEODOSIUS", "MARCHESINUS, JOHANNES", "NIGER, FRANJO", "NIKOLA MODRUŠKI", "NIMIRA, MARTINUS DE", "NONIUS MARCELLUS", "ODONIS, GERALDUS", "PHALARIS", "PLUTARCHUS", "PROBUS, MARCUS VALERIUS", "PROPERTIUS, SEXTUS AURELIUS", "PUCIÆ, KARLO", "SUETONIUS TRANQUILLUS, GAIUS", "TERENTIUS AFER, PUBLIUS", "TIBULLUS, ALBIUS", "TORTELLIUS, JOHANNES", "VALTURIUS, ROBERTUS", "VARRO, MARCUS TERENTIUS", "VERGERIUS, PETRUS PAULUS", "VERGILIUS MARO, PUBLIUS", "ŠIMUN HVARANIN", "ŠIŽGORIÆ, JURAJ"];

  // Populate selects
  function fillSelect(id, values) {
    const el = document.getElementById(id);
    values.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
  }
  fillSelect('placeSelect', ALL_STORAGE);
  fillSelect('instSelect', ALL_INSTIT);
  fillSelect('printerSelect', ALL_PRINTS);
  fillSelect('printPlaceSelect', ALL_PPLACES);
  fillSelect('authorSelect', ALL_AUTHORS);

  function getMultiValues(selectEl) {
    return Array.from(selectEl.options).filter(o => o.selected).map(o => o.value);
  }

  // Map
  const map = L.map('map').setView([45.2, 16.2], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
  const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 9 });
  map.addLayer(cluster);

  function esc(s) { return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
  function size(total) { return Math.max(6, Math.sqrt(total)*3); }

  // Filtriraj jedan "place item" (mjesto čuvanja) prema svim filterima
  function filterItem(item, placesSel, instSel, printersSel, pplacesSel, authorsSel) {
    if (placesSel.length && !placesSel.includes(item.place)) return null;

    // Prođi kroz ustanove; filtriraj po instSel (ako je odabrano) i po egzemplarskim filterima
    const insts = [];
    let total = 0;

    item.institutions.forEach(inst => {
      if (instSel.length && !instSel.includes(inst.institution)) return;
      const ex = inst.exemplars.filter(e => {
        if (printersSel.length && !printersSel.includes(e.printer)) return false;
        if (authorsSel.length  && !authorsSel.includes(e.author)) return false;
        if (pplacesSel.length) {
          const pp = Array.isArray(e.print_places) ? e.print_places : [];
          if (!pp.some(x => pplacesSel.includes(x))) return false;
        }
        return true;
      });
      if (ex.length) {
        insts.push({ institution: inst.institution, count: ex.length, exemplars: ex });
        total += ex.length;
      }
    });

    if (!total) return null;
    return { place: item.place, lat: item.lat, lon: item.lon, total, institutions: insts };
  }

  function popupHTML(item) {
    // Popup koji prikazuje sve ustanove u mjestu; svaka ustanova se može otvoriti (details)
    const parts = [];
    parts.push(`<div><b>${esc(item.place)}</b> — <span class="badge">Ukupno primjeraka: ${item.total}</span></div>`);
    parts.push('<div class="inst-list">');
    item.institutions.forEach(inst => {
      const rows = inst.exemplars.map(e => {
        const pp = (Array.isArray(e.print_places) ? e.print_places.join('; ') : '');
        return `<tr>
          <td>${esc(e.author)}</td>
          <td>${esc(e.title)}</td>
          <td>${e.year ?? ''}</td>
          <td>${esc(e.printer)}</td>
          <td>${esc(pp)}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="5"><em>Nema zapisa</em></td></tr>';

      parts.push(`
        <details>
          <summary><b>${esc(inst.institution)}</b> — primjeraka: ${inst.count}</summary>
          <table>
            <thead><tr><th>Autor</th><th>Naslov</th><th>God.</th><th>Tiskar</th><th>Mjesto tiskanja</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </details>
      `);
    });
    parts.push('</div>');
    return parts.join('');
  }

  function buildMarkers(items) {
    cluster.clearLayers();
    const bounds = [];
    items.forEach(item => {
      const m = L.circleMarker([item.lat, item.lon], {
        radius: size(item.total), color:'darkgreen', weight:1, fillColor:'#065f46', fillOpacity:0.65
      }).bindTooltip(`${item.place} — ukupno ${item.total}`, {sticky:true})
        .bindPopup(popupHTML(item));
      cluster.addLayer(m);
      bounds.push([item.lat, item.lon]);
    });
    if (bounds.length) {
      const b = L.latLngBounds(bounds);
      map.fitBounds(b.pad(0.2));
    }
  }

  function currentFilters() {
    const placesSel   = getMultiValues(document.getElementById('placeSelect'));
    const instSel     = getMultiValues(document.getElementById('instSelect'));
    const printersSel = getMultiValues(document.getElementById('printerSelect'));
    const pplacesSel  = getMultiValues(document.getElementById('printPlaceSelect'));
    const authorsSel  = getMultiValues(document.getElementById('authorSelect'));
    return { placesSel, instSel, printersSel, pplacesSel, authorsSel };
  }

  function applyFilters() {
    const {placesSel, instSel, printersSel, pplacesSel, authorsSel} = currentFilters();
    const subset = RAW.map(item => filterItem(item, placesSel, instSel, printersSel, pplacesSel, authorsSel)).filter(Boolean);
    buildMarkers(subset);
  }

  function resetFilters() {
    ['placeSelect','instSelect','printerSelect','printPlaceSelect','authorSelect'].forEach(id => {
      Array.from(document.getElementById(id).options).forEach(o => o.selected = false);
    });
    const subset = RAW.map(item => filterItem(item, [], [], [], [], [])).filter(Boolean);
    buildMarkers(subset);
  }

  // CSV export (trenutni filter → plosnati popis primjeraka s mjestom i ustanovom)
  function toCSV(rows, headers) {
    const escCell = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const lines = [];
    lines.push(headers.map(escCell).join(','));
    rows.forEach(r => lines.push(headers.map(h => escCell(r[h])).join(',')));
    return lines.join('\n');
  }
  function download(filename, text) {
    const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function buildFilteredRowsFlat() {
    const {placesSel, instSel, printersSel, pplacesSel, authorsSel} = currentFilters();
    const rows = [];
    RAW.forEach(item => {
      if (placesSel.length && !placesSel.includes(item.place)) return;
      item.institutions.forEach(inst => {
        if (instSel.length && !instSel.includes(inst.institution)) return;
        inst.exemplars.forEach(e => {
          if (printersSel.length && !printersSel.includes(e.printer)) return;
          if (authorsSel.length  && !authorsSel.includes(e.author)) return;
          if (pplacesSel.length) {
            const pp = Array.isArray(e.print_places) ? e.print_places : [];
            if (!pp.some(x => pplacesSel.includes(x))) return;
          }
          rows.push({
            "Mjesto (ustanova)": item.place,
            "Ustanova": inst.institution,
            "Autor": e.author,
            "Naslov": e.title,
            "Godina": e.year ?? "",
            "Tiskar": e.printer,
            "Mjesto tiskanja": (Array.isArray(e.print_places) ? e.print_places.join('; ') : '')
          });
        });
      });
    });
    return rows;
  }

  document.getElementById('applyBtn').addEventListener('click', applyFilters);
  document.getElementById('resetBtn').addEventListener('click', resetFilters);
  ['placeSelect','instSelect','printerSelect','printPlaceSelect','authorSelect'].forEach(id => {
    document.getElementById(id).addEventListener('change', applyFilters);
  });
  document.getElementById('dlTitlesBtn').addEventListener('click', () => {
    const rows = buildFilteredRowsFlat();
    if (!rows.length) { alert('Nema zapisa za preuzimanje.'); return; }
    const headers = ["Mjesto (ustanova)","Ustanova","Autor","Naslov","Godina","Tiskar","Mjesto tiskanja"];
    download('inkunabule_ustanove_primjerci.csv', toCSV(rows, headers));
  });

  // Initial
  resetFilters();
</script>
</body>
</html>
